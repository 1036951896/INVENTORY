<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguimiento de Pedidos - StoreHub</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/global.css">
  <link rel="stylesheet" href="../css/header-limpio.css">
  <link rel="icon" href="../assets/logo-storehub.svg" type="image/svg+xml">
  <!-- Configurar BACKEND_URL -->
  <script>
    window.BACKEND_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3000'
      : 'https://storehub-api-74yl.onrender.com';
  </script>
  <style>
    body {
      background: #f5f7fa;
    }

    /* Contenedor principal alineado */
    main {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    h1, h2, h3 {
      color: #1a1a1a;
      font-weight: 600;
    }

    /* ===== B√öSQUEDA CONTAINER ===== */
    .filtro-seguimiento {
      background: white;
      padding: 1.2rem 1.4rem;
      border-radius: 12px;
      margin-bottom: 2.5rem;
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
      border: 1px solid #e0e4e8;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .filtro-seguimiento input {
      flex: 1;
      min-width: 220px;
      padding: 0.9rem 1rem;
      border: 1px solid #e0e4e8;
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      color: #1a1a1a;
      background: #f8f9fa;
      transition: all 0.2s ease;
    }

    .filtro-seguimiento input:focus {
      outline: none;
      border-color: #3483fa;
      background: white;
      box-shadow: 0 2px 8px rgba(52, 131, 250, 0.1);
    }

    .filtro-seguimiento input::placeholder {
      color: #999;
    }

    .filtro-seguimiento .btn {
      padding: 0.9rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .filtro-seguimiento .btn-principal {
      background: #3483fa;
      color: white;
    }

    .filtro-seguimiento .btn-principal:hover {
      background: #0055cc;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(52, 131, 250, 0.3);
    }

    .filtro-seguimiento .btn-secundario {
      background: #f0f2f5;
      color: #1a1a1a;
      border: 1px solid #e0e4e8;
    }

    .filtro-seguimiento .btn-secundario:hover {
      background: #e8ecf1;
    }

    .filtro-seguimiento .btn-secundario.btn-logout {
      background: #ffe4e4;
      color: #c44545;
      border-color: #e74c3c;
    }

    .filtro-seguimiento .btn-secundario.btn-logout:hover {
      background: #ffd4d4;
    }

    /* ===== STATUS CARD EMOCIONAL ===== */
    .status-card {
      display: flex;
      gap: 15px;
      align-items: center;
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      padding: 25px;
      border-radius: 16px;
      margin-bottom: 30px;
      border: 2px solid #3483fa;
      box-shadow: 0 8px 24px rgba(52, 131, 250, 0.15);
      position: relative;
      overflow: hidden;
    }

    .status-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(52, 131, 250, 0.1) 0%, transparent 70%);
      border-radius: 50%;
    }

    .status-card-content {
      flex: 1;
      position: relative;
      z-index: 1;
    }

    .status-icon {
      font-size: 48px;
      min-width: 48px;
      text-align: center;
      animation: bounce 2s infinite;
      position: relative;
      z-index: 1;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .status-card h2 {
      margin: 0 0 8px;
      font-size: 24px;
      color: #1a1a1a;
    }

    .status-card p {
      margin: 4px 0 0;
      font-size: 14px;
      color: #555;
      font-weight: 500;
    }

    /* ===== TIMELINE VERTICAL ===== */
    .timeline {
      position: relative;
      margin: 30px 0;
      padding-left: 35px;
      border-left: 3px solid #e0e4e8;
    }

    .timeline-item {
      position: relative;
      margin-bottom: 28px;
      animation: slideIn 0.6s ease-out forwards;
      opacity: 0;
    }

    .timeline-item:nth-child(1) { animation-delay: 0s; }
    .timeline-item:nth-child(2) { animation-delay: 0.1s; }
    .timeline-item:nth-child(3) { animation-delay: 0.2s; }
    .timeline-item:nth-child(4) { animation-delay: 0.3s; }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .timeline-item .dot {
      width: 14px;
      height: 14px;
      background: #ccc;
      border-radius: 50%;
      position: absolute;
      left: -41px;
      top: 5px;
      border: 3px solid white;
      box-shadow: 0 0 0 2px #e0e4e8;
    }

    .timeline-item.completed .dot {
      background: #00a650;
      box-shadow: 0 0 0 2px white, 0 0 0 4px #00a650;
    }

    .timeline-item.active .dot {
      background: #3483fa;
      box-shadow: 0 0 0 2px white, 0 0 0 4px #3483fa;
      width: 18px;
      height: 18px;
      left: -44px;
      top: 3px;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 2px white, 0 0 0 4px #3483fa; }
      50% { box-shadow: 0 0 0 2px white, 0 0 0 8px rgba(52, 131, 250, 0.5); }
    }

    .timeline-item h4 {
      margin: 0 0 4px;
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
    }

    .timeline-item span {
      display: block;
      font-size: 13px;
      color: #999;
      font-weight: 500;
    }

    .timeline-item.completed h4 {
      color: #00a650;
    }

    /* ===== SUMMARY CARD ===== */
    .summary-card,
    .products-card,
    .support-card {
      background: white;
      padding: 24px;
      border-radius: 14px;
      margin-bottom: 24px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.05);
      border: 1px solid #e0e4e8;
      transition: all 0.3s ease;
    }

    .summary-card:hover,
    .products-card:hover,
    .support-card:hover {
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      border-color: #3483fa;
    }

    .summary-card h3,
    .products-card h3,
    .support-card h3 {
      margin: 0 0 16px;
      font-size: 18px;
      color: #1a1a1a;
    }

    .summary-card p {
      margin: 12px 0;
      font-size: 14px;
      color: #555;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .summary-card strong {
      color: #1a1a1a;
      font-weight: 600;
    }

    /* ===== PRODUCTS CARD ===== */
    .product-row {
      display: flex;
      gap: 16px;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid #e0e4e8;
    }

    .product-row:last-child {
      border-bottom: none;
    }

    .product-image {
      width: 70px;
      height: 70px;
      border-radius: 12px;
      background: #f8f9fa;
      flex-shrink: 0;
      border: 1px solid #e0e4e8;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }

    .product-details {
      flex: 1;
    }

    .product-name {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #1a1a1a;
    }

    .product-quantity {
      display: block;
      font-size: 13px;
      color: #999;
      margin-top: 4px;
    }

    .product-price {
      font-size: 16px;
      font-weight: 700;
      color: #00a650;
      text-align: right;
    }

    /* ===== SUPPORT CARD ===== */
    .support-card {
      background: linear-gradient(135deg, #f5f7fa 0%, #f0f2f5 100%);
      text-align: center;
    }

    .support-card p {
      justify-content: center;
      font-size: 15px;
      color: #555;
      margin: 0 0 16px;
    }

    .support-card button {
      background: #3483fa;
      color: white;
      border: none;
      padding: 12px 28px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .support-card button:hover {
      background: #0055cc;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 131, 250, 0.3);
    }

    /* ===== ESTADO VAC√çO ===== */
    .vacio-seguimiento {
      text-align: center;
      padding: 3rem 1.5rem;
      color: #999;
      background: white;
      border-radius: 14px;
      border: 2px dashed #e0e4e8;
    }

    .vacio-seguimiento p {
      margin: 0;
      font-size: 1.2rem;
      color: #1a1a1a;
      font-weight: 600;
    }

    .vacio-seguimiento small {
      display: block;
      margin-top: 0.5rem;
      color: #999;
    }

    /* ===== NO AUTENTICADO ===== */
    .no-autenticado {
      background: #fffbea;
      color: #b8860b;
      padding: 2rem;
      border-radius: 14px;
      margin-bottom: 2rem;
      text-align: center;
      border: 2px solid #f39c12;
      box-shadow: 0 6px 20px rgba(243, 156, 18, 0.1);
    }

    .btn-ir-login {
      background: #3483fa;
      color: white;
      padding: 12px 28px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-top: 1rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-ir-login:hover {
      background: #0055cc;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 131, 250, 0.3);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      main {
        padding: 1.5rem 1rem;
      }

      .filtro-seguimiento {
        flex-direction: column;
        gap: 0.6rem;
      }

      .filtro-seguimiento input,
      .filtro-seguimiento .btn {
        width: 100%;
      }

      .status-card {
        flex-direction: column;
        text-align: center;
      }

      .status-icon {
        font-size: 40px;
      }

      .timeline {
        padding-left: 25px;
      }

      .timeline-item .dot {
        left: -33px;
      }

      .timeline-item.active .dot {
        left: -36px;
      }

      .product-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .product-price {
        text-align: left;
      }

      .summary-card p {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 600px) {
      main {
        padding: 1rem;
      }

      .status-card {
        padding: 18px;
      }

      .status-card h2 {
        font-size: 20px;
      }

      .status-card p {
        font-size: 13px;
      }

      .status-icon {
        font-size: 36px;
      }

      .timeline-item {
        margin-bottom: 24px;
      }

      .summary-card,
      .products-card,
      .support-card {
        padding: 16px;
      }

      .product-image {
        width: 60px;
        height: 60px;
        font-size: 28px;
      }

      .product-name {
        font-size: 14px;
      }

      .product-price {
        font-size: 14px;
      }
    }

    /* ===== STICKY HEADER BAR (NIVEL DIOS) ===== */
    .sticky-status-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      border-bottom: 2px solid #e0e4e8;
      padding: 12px 20px;
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .sticky-status-bar.visible {
      transform: translateY(0);
    }

    .sticky-status-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .sticky-status-icon {
      font-size: 24px;
      min-width: 24px;
    }

    .sticky-status-text h3 {
      margin: 0;
      font-size: 14px;
      color: #1a1a1a;
      font-weight: 600;
    }

    .sticky-status-text p {
      margin: 2px 0 0;
      font-size: 12px;
      color: #999;
    }

    .sticky-status-right {
      font-size: 12px;
      color: #3483fa;
      font-weight: 600;
      white-space: nowrap;
    }

    /* ===== PEOPLE INDICATOR (NIVEL DIOS) ===== */
    .people-indicator {
      background: linear-gradient(135deg, #fff8e1 0%, #fffbea 100%);
      border-left: 4px solid #ffc107;
      padding: 14px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .people-avatars {
      display: flex;
      gap: -8px;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3483fa, #0055cc);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
      border: 2px solid white;
      animation: float 2s ease-in-out infinite;
    }

    .avatar:nth-child(2) { animation-delay: 0.2s; }
    .avatar:nth-child(3) { animation-delay: 0.4s; }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-4px); }
    }

    .people-text {
      flex: 1;
    }

    .people-text p {
      margin: 0;
      font-size: 14px;
      color: #f57c00;
      font-weight: 600;
    }

    .people-text small {
      display: block;
      color: #999;
      font-size: 12px;
      margin-top: 3px;
    }

    /* ===== CONFETTI (NIVEL DIOS) ===== */
    .confetti {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
    }

    .confetti-piece {
      position: fixed;
      width: 10px;
      height: 10px;
      pointer-events: none;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <!-- STICKY STATUS BAR (NIVEL DIOS) üî• -->
  <div class="sticky-status-bar" id="sticky-status-bar">
    <div class="sticky-status-left">
      <div class="sticky-status-icon" id="sticky-icon">üì¶</div>
      <div class="sticky-status-text">
        <h3 id="sticky-title">Tu pedido</h3>
        <p id="sticky-subtitle">Desliza para ver detalles</p>
      </div>
    </div>
    <div class="sticky-status-right" id="sticky-time">Ma√±ana</div>
  </div>

  <!-- ENCABEZADO -->
  <header>
    <div class="contenedor">
      <div class="encabezado-contenedor">
        <!-- LOGO -->
        <div class="logo">
          <img src="../assets/logo-storehub.svg" alt="Logo StoreHub" class="logo-img">
        </div>

        <!-- MENU SUPERIOR -->
        <div class="menu-superior">
          <!-- LINK A √çNDEX -->
          <a href="index.html" class="btn-icono" title="Volver al cat√°logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
              <polyline points="3 9 9 3 15 9"></polyline>
              <path d="M9 3v8a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2V3"></path>
            </svg>
          </a>

          <!-- USUARIO -->
          <div id="menu-usuario">
            <button class="btn-icono" onclick="window.location.href='login.html'" title="Iniciar sesi√≥n">
              <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- CONTENIDO PRINCIPAL -->
  <main>
    <div class="seguimiento-contenedor">
    <div style="text-align: center; margin-bottom: 2rem;">
      <h1 style="font-size: 2.2rem; margin: 0 0 0.5rem;">üì¶ Seguimiento de Pedidos</h1>
      <p style="color: #666; font-size: 15px; margin: 0;">Consulta el estado de tus pedidos en tiempo real</p>
    </div>

    <div class="filtro-seguimiento">
      <input type="text" id="buscar-radicado" placeholder="Buscar por n√∫mero de radicado (ej: PED-123456)">
      <button class="btn btn-principal" onclick="buscarPedido()">Buscar</button>
      <button class="btn btn-secundario" onclick="cargarMisPedidos()">Mostrar Todos</button>
      <button class="btn btn-secundario btn-logout" onclick="cerrarSesionCliente()">Cerrar Sesi√≥n</button>
    </div>

    <div id="contenedor-seguimiento">
      <!-- Se llenar√° con JavaScript -->
    </div>
  </div>

    </div>
    <!-- Fin seguimiento-contenedor -->
  </main>
  <!-- Fin main -->

  <script>
    const BACKEND_URL = window.BACKEND_URL || 'http://localhost:3000';
    let estadoPedidoActual = null;

    document.addEventListener('DOMContentLoaded', function() {
      verificarAutenticacionCliente();
      cargarMisPedidos();
      
      // Control del sticky header
      window.addEventListener('scroll', manejarStickyHeader);
      
      // Actualizar cada 10 segundos
      setInterval(cargarMisPedidos, 10000);
    });

    // ===== STICKY HEADER CONTROL (NIVEL DIOS) =====
    function manejarStickyHeader() {
      const statusCard = document.getElementById('status-card-main');
      const stickyBar = document.getElementById('sticky-status-bar');
      
      if (!statusCard || !stickyBar) return;
      
      const rect = statusCard.getBoundingClientRect();
      
      if (rect.top < -50) {
        stickyBar.classList.add('visible');
      } else {
        stickyBar.classList.remove('visible');
      }
    }

    // ===== ACTUALIZAR STICKY HEADER =====
    function actualizarStickyHeader(estado, emoji, textoCorto, fechaEntrega) {
      const stickyIcon = document.getElementById('sticky-icon');
      const stickyTitle = document.getElementById('sticky-title');
      const stickySubtitle = document.getElementById('sticky-subtitle');
      const stickyTime = document.getElementById('sticky-time');
      
      if (stickyIcon) stickyIcon.textContent = emoji;
      if (stickyTitle) stickyTitle.textContent = textoCorto;
      if (stickySubtitle) stickySubtitle.textContent = estado === 'ENTREGADO' ? '‚úÖ Completo' : 'Desliza para ver detalles';
      if (stickyTime) stickyTime.textContent = fechaEntrega;
    }

    // ===== CONFETTI EXPLOSI√ìN (NIVEL DIOS) =====
    function dispararConfetti() {
      const colores = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA502', '#FF1493'];
      
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti-piece';
        
        const x = Math.random() * window.innerWidth;
        const y = Math.random() * window.innerHeight - window.innerHeight;
        const tamano = Math.random() * 8 + 4;
        const duracion = Math.random() * 2 + 2;
        const rotacion = Math.random() * 360;
        
        confetti.style.cssText = `
          left: ${x}px;
          top: ${y}px;
          width: ${tamano}px;
          height: ${tamano}px;
          background: ${colores[Math.floor(Math.random() * colores.length)]};
          border-radius: 50%;
          animation: caerConfetti ${duracion}s linear forwards;
          opacity: 1;
        `;
        
        document.body.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), duracion * 1000);
      }
      
      // Agregar estilos de animaci√≥n din√°mico
      if (!document.getElementById('confetti-styles')) {
        const style = document.createElement('style');
        style.id = 'confetti-styles';
        style.innerHTML = `
          @keyframes caerConfetti {
            to {
              transform: translateY(${window.innerHeight + 100}px) rotate(720deg);
              opacity: 0;
            }
          }
        `;
        document.head.appendChild(style);
      }
    }

    // ===== MOSTRAR CONFETTI CON MENSAJE =====
    function mostrarEntregaCompleta() {
      dispararConfetti();
      
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
      `;
      
      modal.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
          <div style="font-size: 60px; margin-bottom: 20px;">üéâ</div>
          <h2 style="margin: 0 0 10px; font-size: 24px; color: #1a1a1a;">¬°Pedido Entregado!</h2>
          <p style="margin: 0 0 20px; color: #666; font-size: 15px;">Gracias por tu compra en StoreHub</p>
          <p style="margin: 0 0 20px; color: #999; font-size: 13px;">Te esperamos pronto üíö</p>
          <button onclick="this.parentElement.parentElement.remove()" style="background: #3483fa; color: white; border: none; padding: 12px 28px; border-radius: 10px; cursor: pointer; font-weight: 600;">Volver al inicio</button>
        </div>
      `;
      
      const style = document.createElement('style');
      style.innerHTML = `
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(modal);
      
      setTimeout(() => modal.remove(), 5000);
    }

    function verificarAutenticacionCliente() {
      const usuarioStr = localStorage.getItem('usuario');
      if (!usuarioStr) {
        mostrarNoAutenticado();
        return false;
      }
      return true;
    }

    function mostrarNoAutenticado() {
      const contenedor = document.getElementById('contenedor-seguimiento');
      contenedor.innerHTML = `
        <div class="no-autenticado">
          <p><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="display: inline-block; margin-right: 8px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3.04h16.94a2 2 0 0 0 1.71-3.04l-8.47-14.14a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>Debes iniciar sesi√≥n para ver tus pedidos</p>
          <a href="login.html" class="btn-ir-login">Ir a Iniciar Sesi√≥n</a>
        </div>
      `;
    }

    async function cargarMisPedidos() {
      if (!verificarAutenticacionCliente()) return;

      const usuarioStr = localStorage.getItem('usuario');
      const usuario = JSON.parse(usuarioStr);
      const token = usuario.access_token;

      try {
        const resp = await fetch(`${BACKEND_URL}/api/v1/orders`, {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!resp.ok) {
          if (resp.status === 401) {
            mostrarNoAutenticado();
            localStorage.removeItem('usuario');
          }
          return;
        }

        const pedidos = await resp.json();
        const pedidosArray = Array.isArray(pedidos) ? pedidos : (Array.isArray(pedidos.data) ? pedidos.data : []);
        
        // Detectar cambio de estado (NIVEL DIOS) üéä
        if (pedidosArray.length > 0) {
          const nuevoEstado = pedidosArray[0].estado;
          
          if (estadoPedidoActual && estadoPedidoActual !== nuevoEstado) {
            // Estado cambi√≥! Mostrar animaci√≥n
            mostrarCambioEstado(estadoPedidoActual, nuevoEstado);
          }
        }
        
        mostrarPedidos(pedidosArray);
      } catch (err) {
        console.error('Error cargando pedidos:', err);
        document.getElementById('contenedor-seguimiento').innerHTML = `
          <div class="vacio-seguimiento">
            <p><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" style="display: inline-block; margin-right: 8px;\"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>Error al conectar con el servidor. Intenta m√°s tarde.</p>
          </div>
        `;
      }
    }

    // ===== MOSTRAR CAMBIO DE ESTADO =====
    function mostrarCambioEstado(estadoAnterior, nuevoEstado) {
      const estados = {
        'PENDIENTE': { emoji: '‚è≥', texto: 'Pedido confirmado' },
        'EN_PREPARACION': { emoji: 'üì¶', texto: 'Preparando tu pedido' },
        'ENVIADO': { emoji: 'üöö', texto: 'Tu pedido est√° en camino' },
        'ENTREGADO': { emoji: '‚úÖ', texto: '¬°Pedido entregado!' }
      };
      
      const info = estados[nuevoEstado] || { emoji: 'üìã', texto: 'Actualizaci√≥n' };
      
      // Notificaci√≥n toast animada
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        z-index: 9998;
        animation: slideUpToast 0.4s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        border-left: 4px solid #3483fa;
      `;
      
      toast.innerHTML = `
        <div style="font-size: 28px;">${info.emoji}</div>
        <div>
          <div style="font-weight: 600; color: #1a1a1a; font-size: 14px;">${info.texto}</div>
          <div style="font-size: 12px; color: #999;">Tu orden ha sido actualizada</div>
        </div>
      `;
      
      document.body.appendChild(toast);
      
      // Agregar animaci√≥n si no existe
      if (!document.getElementById('toast-animation')) {
        const style = document.createElement('style');
        style.id = 'toast-animation';
        style.innerHTML = `
          @keyframes slideUpToast {
            from {
              transform: translateY(100px);
              opacity: 0;
            }
            to {
              transform: translateY(0);
              opacity: 1;
            }
          }
        `;
        document.head.appendChild(style);
      }
      
      setTimeout(() => {
        toast.style.animation = 'slideUpToast 0.4s ease reverse';
        setTimeout(() => toast.remove(), 400);
      }, 4000);
    }

    function buscarPedido() {
      const radicado = document.getElementById('buscar-radicado').value.trim();
      if (!radicado) {
        alert('Por favor ingresa un n√∫mero de radicado');
        return;
      }

      const usuarioStr = localStorage.getItem('usuario');
      if (!usuarioStr) {
        mostrarNoAutenticado();
        return;
      }

      const usuario = JSON.parse(usuarioStr);
      const token = usuario.access_token;

      fetch(`${BACKEND_URL}/api/v1/orders`, {
        headers: {
          'Authorization': 'Bearer ' + token
        }
      })
        .then(r => r.json())
        .then(data => {
          const pedidos = Array.isArray(data) ? data : (Array.isArray(data.data) ? data.data : []);
          const encontrado = pedidos.filter(p => p.numero === radicado);
          mostrarPedidos(encontrado);
        });
    }

    function mostrarPedidos(pedidos) {
      const contenedor = document.getElementById('contenedor-seguimiento');

      if (pedidos.length === 0) {
        contenedor.innerHTML = `
          <div class="vacio-seguimiento">
            <p>üì≠ A√∫n no tienes pedidos</p>
            <small>Realiza tu primera compra y s√≠guelo aqu√≠ en tiempo real</small>
          </div>
        `;
        return;
      }

      // Renderizar primer pedido (m√°s reciente)
      const pedidoPrincipal = pedidos[0];
      estadoPedidoActual = pedidoPrincipal.estado;
      
      contenedor.innerHTML = pedidos.map(pedido => generarTarjetaSeguimiento(pedido)).join('');
      
      // Actualizar sticky header
      const emoji = obtenerEmojiEstado(pedidoPrincipal.estado);
      const textoCorto = obtenerTextoCorto(pedidoPrincipal.estado);
      const fechaEntrega = calcularFechaEntrega(pedidoPrincipal.estado, new Date(pedidoPrincipal.createdAt));
      
      actualizarStickyHeader(pedidoPrincipal.estado, emoji, textoCorto, fechaEntrega);
      
      // Si est√° entregado, mostrar confetti (pero solo la primera vez)
      if (pedidoPrincipal.estado === 'ENTREGADO' && !sessionStorage.getItem('entrega-celebrada')) {
        sessionStorage.setItem('entrega-celebrada', 'true');
        setTimeout(mostrarEntregaCompleta, 500);
      }
    }

    function obtenerTextoCorto(estado) {
      switch(estado) {
        case 'PENDIENTE': return 'Confirmado';
        case 'EN_PREPARACION': return 'Preparando';
        case 'ENVIADO': return 'En camino';
        case 'ENTREGADO': return '¬°Entregado!';
        default: return 'Procesando';
      }
    }

    function generarTarjetaSeguimiento(pedido) {
      const estadoClass = obtenerClaseEstado(pedido.estado);
      const estadoTexto = obtenerTextoEstadoSimple(pedido.estado);
      const estadoEmoji = obtenerEmojiEstado(pedido.estado);
      const fechaEntrega = calcularFechaEntrega(pedido.estado, new Date(pedido.createdAt));
      
      const fecha = new Date(pedido.createdAt);
      const fechaFormato = fecha.toLocaleDateString('es-CO', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
      
      const total = pedido.total || 0;
      
      // Timeline items
      const timelineHtml = generarTimeline(pedido.estado);
      
      // Productos
      const itemsHtml = (pedido.items || []).map(item => {
        const emoji = obtenerEmojiProducto(item.producto?.nombre || 'Producto');
        return `
        <div class="product-row">
          <div class="product-image">${emoji}</div>
          <div class="product-details">
            <h3 class="product-name">${item.producto?.nombre || 'Producto'}</h3>
            <span class="product-quantity">${item.cantidad}x $${(item.precioUnitario || 0).toLocaleString('es-CO')}</span>
          </div>
          <div class="product-price">$${(item.cantidad * (item.precioUnitario || 0)).toLocaleString('es-CO')}</div>
        </div>
        `;
      }).join('');

      return `
        <div>
          <!-- PEOPLE INDICATOR (NIVEL DIOS) -->
          ${estadoActual === 'EN_PREPARACION' ? `
            <div class="people-indicator">
              <div class="people-avatars">
                <div class="avatar">üë§</div>
                <div class="avatar">üë§</div>
                <div class="avatar">üë§</div>
              </div>
              <div class="people-text">
                <p>üëÄ 3 personas preparando tu pedido</p>
                <small>Trabajando en tu orden ahora mismo</small>
              </div>
            </div>
          ` : ''}

          <!-- STATUS CARD EMOCIONAL -->
          <div class="status-card" id="status-card-main">
            <div class="status-icon">${estadoEmoji}</div>
            <div class="status-card-content">
              <h2>${estadoTexto}</h2>
              <p>Entrega estimada: ${fechaEntrega}</p>
            </div>
          </div>

          <!-- TIMELINE VERTICAL -->
          <div class="timeline">
            ${timelineHtml}
          </div>

          <!-- SUMMARY CARD -->
          <div class="summary-card">
            <h3>üìã Resumen del Pedido</h3>
            <p><strong>N√∫mero:</strong> ${pedido.numero}</p>
            <p><strong>Realizado:</strong> ${fechaFormato}</p>
            <p><strong>Cliente:</strong> ${pedido.usuario?.nombre || 'Desconocido'}</p>
            <p><strong>Tel√©fono:</strong> ${pedido.usuario?.telefono || 'N/A'}</p>
            <p style="border-top: 1px solid #e0e4e8; padding-top: 12px; margin-top: 12px;"><strong style="color: #00a650; font-size: 18px;">Total:</strong> <span style="color: #00a650; font-size: 18px;">$${total.toLocaleString('es-CO')}</span></p>
          </div>

          <!-- PRODUCTS CARD -->
          <div class="products-card">
            <h3>üì¶ Productos (${pedido.items?.length || 0} art√≠culos)</h3>
            ${itemsHtml}
          </div>

          <!-- SUPPORT CARD -->
          <div class="support-card">
            <p>¬øNecesitas ayuda con tu pedido?</p>
            <button onclick="alert('Soporte por WhatsApp: +57 3001234567')">üí¨ Contactar por WhatsApp</button>
          </div>
        </div>
      `;
    }

    function obtenerEmojiEstado(estado) {
      switch(estado) {
        case 'PENDIENTE': return '‚è≥';
        case 'EN_PREPARACION': return 'üì¶';
        case 'ENVIADO': return 'üöö';
        case 'ENTREGADO': return '‚úÖ';
        default: return 'üìã';
      }
    }

    function obtenerTextoEstadoSimple(estado) {
      switch(estado) {
        case 'PENDIENTE': return 'Tu pedido est√° confirmado';
        case 'EN_PREPARACION': return 'Estamos preparando tu pedido';
        case 'ENVIADO': return 'Tu pedido est√° en camino';
        case 'ENTREGADO': return '¬°Pedido entregado!';
        default: return 'Procesando tu pedido';
      }
    }

    function obtenerEmojiProducto(nombre) {
      nombre = nombre.toLowerCase();
      if (nombre.includes('papa') || nombre.includes('snack')) return 'ü•î';
      if (nombre.includes('agua') || nombre.includes('bebida') || nombre.includes('vini')) return 'ü•§';
      if (nombre.includes('aceite') || nombre.includes('manteca')) return 'ü´í';
      if (nombre.includes('az√∫car') || nombre.includes('sal')) return 'üç¨';
      if (nombre.includes('arroz') || nombre.includes('pasta')) return 'üçö';
      if (nombre.includes('pan') || nombre.includes('harina')) return 'üçû';
      if (nombre.includes('leche') || nombre.includes('queso') || nombre.includes('l√°cteo')) return 'ü•õ';
      if (nombre.includes('limpieza') || nombre.includes('detergente')) return 'üßπ';
      if (nombre.includes('papel') || nombre.includes('toalla') || nombre.includes('servilleta')) return 'üßª';
      if (nombre.includes('guante') || nombre.includes('bolsa')) return 'üõçÔ∏è';
      return 'üì¶';
    }

    function calcularFechaEntrega(estado, fechaPedido) {
      if (estado === 'ENTREGADO') return '‚ú® Ya entregado';
      
      const hoy = new Date();
      const ma√±ana = new Date(hoy);
      ma√±ana.setDate(ma√±ana.getDate() + 1);
      
      const ma√±anaTexto = ma√±ana.toLocaleDateString('es-CO', { weekday: 'long', day: 'numeric', month: 'short' });
      
      if (estado === 'ENVIADO') return `Ma√±ana ${ma√±anaTexto} antes de las 6:00 p.m.`;
      if (estado === 'EN_PREPARACION') return `${ma√±anaTexto} o pasado ma√±ana`;
      return `${ma√±anaTexto} (estimado)`;
    }

    function generarTimeline(estadoActual) {
      const estados = ['PENDIENTE', 'EN_PREPARACION', 'ENVIADO', 'ENTREGADO'];
      const etiquetas = ['Pedido Recibido', 'Pago Confirmado', 'Enviado', 'Entregado'];
      const indiceActual = estados.indexOf(estadoActual);

      return etiquetas.map((label, index) => {
        let clase = '';
        if (index < indiceActual) {
          clase = 'completed';
        } else if (index === indiceActual) {
          clase = 'active';
        }

        const ahora = new Date();
        const tiempo = ahora.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });

        return `
          <div class="timeline-item ${clase}">
            <div class="dot"></div>
            <h4>${label}</h4>
            ${clase === 'completed' ? `<span>${ahora.toLocaleDateString('es-CO')} ¬∑ ${tiempo}</span>` : (clase === 'active' ? `<span>En proceso</span>` : '')}
          </div>
        `;
      }).join('');
    }

    function obtenerClaseEstado(estado) {
      // Funci√≥n auxiliar, ya no se usa en nueva estructura
      switch(estado) {
        case 'PENDIENTE': return 'pendiente';
        case 'EN_PREPARACION': return 'procesando';
        case 'ENVIADO': return 'enviado';
        case 'ENTREGADO': return 'entregado';
        default: return 'pendiente';
      }
    }

    function cerrarSesionCliente() {
      if (confirm('¬øSeguro que deseas cerrar sesi√≥n?')) {
        localStorage.removeItem('usuario');
        window.location.href = 'index.html';
      }
    }
  </script>
  <script>
    window.BACKEND_URL = 'http://localhost:3000';
  </script>
</body>
</html>
