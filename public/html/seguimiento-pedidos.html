<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguimiento de Pedidos - StoreHub</title>
  <link rel="stylesheet" href="../css/global.css">
  <link rel="icon" href="../assets/logo.svg" type="image/svg+xml">
  <style>
    .seguimiento-contenedor {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
    }

    .seguimiento-header {
      margin-bottom: 2rem;
      text-align: center;
    }

    .seguimiento-header h1 {
      color: var(--azul-oscuro);
      margin-bottom: 0.5rem;
    }

    .filtro-seguimiento {
      background: #f5f5f5;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .filtro-seguimiento input {
      flex: 1;
      min-width: 200px;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }

    .filtro-seguimiento button {
      padding: 0.75rem 1.5rem;
      background: var(--azul-oscuro);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

    .filtro-seguimiento button:hover {
      background: var(--azul);
    }

    .pedidos-lista-seguimiento {
      display: grid;
      gap: 1.5rem;
    }

    .pedido-seguimiento {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .pedido-seguimiento-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f0f0f0;
    }

    .pedido-radicado {
      font-weight: bold;
      color: var(--azul-oscuro);
      font-size: 1.2rem;
    }

    .estado-badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
    }

    .estado-badge.pendiente {
      background: #fff3cd;
      color: #856404;
    }

    .estado-badge.procesando {
      background: #d1ecf1;
      color: #0c5460;
    }

    .estado-badge.enviado {
      background: #cfe2ff;
      color: #084298;
    }

    .estado-badge.entregado {
      background: #d1e7dd;
      color: #0f5132;
    }

    .pedido-detalles-seguimiento {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .detalle-item {
      background: #f9f9f9;
      padding: 1rem;
      border-radius: 4px;
    }

    .detalle-label {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.25rem;
    }

    .detalle-valor {
      font-size: 1rem;
      color: var(--azul-oscuro);
      font-weight: bold;
    }

    .timeline-seguimiento {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 2px solid #f0f0f0;
    }

    .timeline-title {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 1rem;
      font-weight: bold;
    }

    .timeline-items {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      padding: 0.5rem 0;
    }

    .timeline-item {
      min-width: 120px;
      text-align: center;
    }

    .timeline-dot {
      width: 12px;
      height: 12px;
      background: #ddd;
      border-radius: 50%;
      margin: 0 auto 0.5rem;
      display: block;
    }

    .timeline-item.activo .timeline-dot {
      background: var(--exito);
      width: 18px;
      height: 18px;
      margin: -3px auto 0.5rem;
    }

    .timeline-label {
      font-size: 0.8rem;
      color: #666;
    }

    .timeline-item.activo .timeline-label {
      color: var(--exito);
      font-weight: bold;
    }

    .pedido-items {
      margin-top: 1rem;
      background: #f9f9f9;
      padding: 1rem;
      border-radius: 4px;
    }

    .items-title {
      font-size: 0.9rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: var(--azul-oscuro);
    }

    .item-lista {
      display: grid;
      gap: 0.5rem;
    }

    .item-fila {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .item-fila:last-child {
      border-bottom: none;
    }

    .vacio-seguimiento {
      text-align: center;
      padding: 2rem;
      color: #999;
    }

    .no-autenticado {
      background: #f8d7da;
      color: #721c24;
      padding: 1.5rem;
      border-radius: 4px;
      margin-bottom: 2rem;
      text-align: center;
    }

    .btn-ir-login {
      background: var(--azul-oscuro);
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      margin-top: 1rem;
    }

    .btn-ir-login:hover {
      background: var(--azul);
    }
  </style>
</head>
<body style="background-color: #f5f5f5;">
  <div class="seguimiento-contenedor">
    <div class="seguimiento-header">
      <h1>ðŸ“¦ Seguimiento de Pedidos</h1>
      <p>Consulta el estado de tus pedidos en tiempo real</p>
    </div>

    <div class="filtro-seguimiento">
      <input type="text" id="buscar-radicado" placeholder="Buscar por nÃºmero de radicado (ej: PED-123456)">
      <button onclick="buscarPedido()">Buscar</button>
      <button onclick="cargarMisPedidos()" style="background: #666;">Mostrar Todos</button>
      <button onclick="cerrarSesionCliente()" style="background: #c33;">Cerrar SesiÃ³n</button>
    </div>

    <div id="contenedor-seguimiento">
      <!-- Se llenarÃ¡ con JavaScript -->
    </div>
  </div>

  <script>
    const BACKEND_URL = window.BACKEND_URL || 'http://localhost:3000';

    document.addEventListener('DOMContentLoaded', function() {
      verificarAutenticacionCliente();
      cargarMisPedidos();
      
      // Actualizar cada 10 segundos
      setInterval(cargarMisPedidos, 10000);
    });

    function verificarAutenticacionCliente() {
      const usuarioStr = localStorage.getItem('usuario');
      if (!usuarioStr) {
        mostrarNoAutenticado();
        return false;
      }
      return true;
    }

    function mostrarNoAutenticado() {
      const contenedor = document.getElementById('contenedor-seguimiento');
      contenedor.innerHTML = `
        <div class="no-autenticado">
          <p><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="display: inline-block; margin-right: 8px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3.04h16.94a2 2 0 0 0 1.71-3.04l-8.47-14.14a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>Debes iniciar sesiÃ³n para ver tus pedidos</p>
          <a href="login.html" class="btn-ir-login">Ir a Iniciar SesiÃ³n</a>
        </div>
      `;
    }

    async function cargarMisPedidos() {
      if (!verificarAutenticacionCliente()) return;

      const usuarioStr = localStorage.getItem('usuario');
      const usuario = JSON.parse(usuarioStr);
      const token = usuario.access_token;

      try {
        const resp = await fetch(`${BACKEND_URL}/api/v1/orders`, {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!resp.ok) {
          if (resp.status === 401) {
            mostrarNoAutenticado();
            localStorage.removeItem('usuario');
          }
          return;
        }

        const pedidos = await resp.json();
        mostrarPedidos(Array.isArray(pedidos) ? pedidos : (Array.isArray(pedidos.data) ? pedidos.data : []));
      } catch (err) {
        console.error('Error cargando pedidos:', err);
        document.getElementById('contenedor-seguimiento').innerHTML = `
          <div class="vacio-seguimiento">
            <p><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24" style="display: inline-block; margin-right: 8px;\"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>Error al conectar con el servidor. Intenta mÃ¡s tarde.</p>
          </div>
        `;
      }
    }

    function buscarPedido() {
      const radicado = document.getElementById('buscar-radicado').value.trim();
      if (!radicado) {
        alert('Por favor ingresa un nÃºmero de radicado');
        return;
      }

      const usuarioStr = localStorage.getItem('usuario');
      if (!usuarioStr) {
        mostrarNoAutenticado();
        return;
      }

      const usuario = JSON.parse(usuarioStr);
      const token = usuario.access_token;

      fetch(`${BACKEND_URL}/api/v1/orders`, {
        headers: {
          'Authorization': 'Bearer ' + token
        }
      })
        .then(r => r.json())
        .then(data => {
          const pedidos = Array.isArray(data) ? data : (Array.isArray(data.data) ? data.data : []);
          const encontrado = pedidos.filter(p => p.numero === radicado);
          mostrarPedidos(encontrado);
        });
    }

    function mostrarPedidos(pedidos) {
      const contenedor = document.getElementById('contenedor-seguimiento');

      if (pedidos.length === 0) {
        contenedor.innerHTML = `
          <div class="vacio-seguimiento">
            <p>ðŸ“­ No tienes pedidos aÃºn</p>
            <small>Haz tu primer compra y podrÃ¡s seguir aquÃ­</small>
          </div>
        `;
        return;
      }

      contenedor.innerHTML = pedidos.map(pedido => generarTarjetaSeguimiento(pedido)).join('');
    }

    function generarTarjetaSeguimiento(pedido) {
      const estadoClass = obtenerClaseEstado(pedido.estado);
      const estadoTexto = obtenerTextoEstado(pedido.estado);
      const timeline = generarTimeline(pedido.estado);

      const fecha = new Date(pedido.createdAt);
      const fechaFormato = fecha.toLocaleDateString('es-CO');
      const horaFormato = fecha.toLocaleTimeString('es-CO');

      const total = pedido.total || 0;
      const itemsHtml = (pedido.items || []).map(item => `
        <div class="item-fila">
          <span>${item.producto?.nombre || 'Producto'}</span>
          <span>${item.cantidad} Ã— $${(item.precioUnitario || 0).toLocaleString('es-CO')}</span>
        </div>
      `).join('');

      return `
        <div class="pedido-seguimiento">
          <div class="pedido-seguimiento-header">
            <div class="pedido-radicado">${pedido.numero}</div>
            <span class="estado-badge ${estadoClass}">${estadoTexto}</span>
          </div>

          <div class="pedido-detalles-seguimiento">
            <div class="detalle-item">
              <div class="detalle-label">ðŸ“… Fecha del Pedido</div>
              <div class="detalle-valor">${fechaFormato} ${horaFormato}</div>
            </div>
            <div class="detalle-item">
              <div class="detalle-label">Cliente</div>
              <div class="detalle-valor">${pedido.usuario?.nombre || 'Desconocido'}</div>
            </div>
            <div class="detalle-item">
              <div class="detalle-label">TelÃ©fono</div>
              <div class="detalle-valor">${pedido.usuario?.telefono || 'N/A'}</div>
            </div>
            <div class="detalle-item">
              <div class="detalle-label">Total</div>
              <div class="detalle-valor">$${total.toLocaleString('es-CO')}</div>
            </div>
          </div>

          <div class="pedido-items">
            <div class="items-title">ðŸ“¦ Productos (${pedido.items?.length || 0} artÃ­culos)</div>
            <div class="item-lista">
              ${itemsHtml}
            </div>
          </div>

          <div class="timeline-seguimiento">
            <div class="timeline-title">ðŸšš Estado del EnvÃ­o</div>
            <div class="timeline-items">
              ${timeline}
            </div>
          </div>
        </div>
      `;
    }

    function obtenerClaseEstado(estado) {
      switch(estado) {
        case 'PENDIENTE': return 'pendiente';
        case 'EN_PREPARACION': return 'procesando';
        case 'ENVIADO': return 'enviado';
        case 'ENTREGADO': return 'entregado';
        default: return 'pendiente';
      }
    }

    function obtenerTextoEstado(estado) {
      switch(estado) {
        case 'PENDIENTE': return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="display: inline-block; margin-right: 8px;"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>Pendiente';
        case 'EN_PREPARACION': return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="display: inline-block; margin-right: 8px;"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m0 5.08l-4.24 4.24M1 12h6m6 0h6M4.22 19.78l4.24-4.24m5.08 0l4.24 4.24M19.78 19.78l-4.24-4.24m0-5.08l4.24-4.24M23 12h-6m-6 0H5M19.78 4.22l-4.24 4.24m-5.08 0l-4.24-4.24"></path></svg>En Preparaci\u00f3n';
        case 'ENVIADO': return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" style="display: inline-block; margin-right: 8px;\"><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zm-9-2H3m8 0h8m-4-13h1a1 1 0 0 1 1 1v5a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2V6a1 1 0 0 1 1-1h1\"></path></svg>Enviado';
        case 'ENTREGADO': return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16\" style="display: inline-block; margin-right: 8px;\"><polyline points=\"20 6 9 17 4 12\"></polyline></svg>Entregado';
        default: return estado;
      }
    }

    function generarTimeline(estadoActual) {
      const estados = ['PENDIENTE', 'EN_PREPARACION', 'ENVIADO', 'ENTREGADO'];
      const etiquetas = ['Registrado', 'Preparando', 'Enviado', 'Entregado'];

      return estados.map((estado, index) => {
        const esActivo = estados.indexOf(estadoActual) >= index;
        return `
          <div class="timeline-item ${esActivo ? 'activo' : ''}">
            <span class="timeline-dot"></span>
            <div class="timeline-label">${etiquetas[index]}</div>
          </div>
        `;
      }).join('');
    }

    function cerrarSesionCliente() {
      if (confirm('Â¿Seguro que deseas cerrar sesiÃ³n?')) {
        localStorage.removeItem('usuario');
        window.location.href = 'index.html';
      }
    }
  </script>
  <script>
    window.BACKEND_URL = 'http://localhost:3000';
  </script>
</body>
</html>
